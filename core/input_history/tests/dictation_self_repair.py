from ..input_history import InputHistoryManager
from ...utils.test import create_test_suite

def get_filled_ihm():
    input_history = InputHistoryManager()
    input_history.insert_input_events(input_history.text_to_input_history_events("Insert ", "insert"))
    input_history.insert_input_events(input_history.text_to_input_history_events("a ", "a"))
    input_history.insert_input_events(input_history.text_to_input_history_events("new ", "new"))
    input_history.insert_input_events(input_history.text_to_input_history_events("sentence ", "sentence"))
    input_history.insert_input_events(input_history.text_to_input_history_events("or ", "or"))
    input_history.insert_input_events(input_history.text_to_input_history_events("insert ", "insert"))
    input_history.insert_input_events(input_history.text_to_input_history_events("a ", "a"))
    input_history.insert_input_events(input_history.text_to_input_history_events("new ", "new"))
    input_history.insert_input_events(input_history.text_to_input_history_events("paragraph", "paragraph"))
    return input_history

def get_filled_ihm_with_examples(examples):
    input_history = InputHistoryManager()
    for index, example in enumerate(examples):
        input_history.insert_input_events(input_history.text_to_input_history_events(example + " " if index < len(examples) - 1 else example, example))
    return input_history

def test_detect_self_repair(assertion):
    input_history = get_filled_ihm()
    assertion( "With a filled input history, testing self repair in dictation")
    assertion( "    Repetition")
    assertion( "        Inserting the last placed word 'paragraph'...")
    assertion( "            Should result in a detected self repair", input_history.detect_self_repair(["paragraph"]) )
    assertion( "        Inserting the last placed words 'new paragraph'...")
    assertion( "            Should result in a detected self repair", input_history.detect_self_repair(["new", "paragraph"]) )
    assertion( "        Inserting the last placed words 'a new paragraph'...")
    assertion( "            Should result in a detected self repair", input_history.detect_self_repair(["a", "new", "paragraph"]) )
    assertion( "        Inserting the words 'paragraph word'... ")
    assertion( "            Should result in a detected self repair", input_history.detect_self_repair(["paragraph", "word"]) == True )
    assertion( "        Inserting the words 'a new paragraph with a new word'... ") 
    assertion( "            Should result in a detected self repair", input_history.detect_self_repair("a new paragraph with a new word".split()) == True )
    assertion( "    Appending ( no context or too far back)" )
    assertion( "        Inserting the word 'word'...")
    assertion( "            Should not result in a detected self repair", input_history.detect_self_repair(["word"]) == False )
    assertion( "        Inserting the words 'insert word'...")
    assertion( "            Should not result in a detected self repair", input_history.detect_self_repair(["insert", "word"]) == False )
    assertion( "    Deletion of word")
    assertion( "        Inserting the words 'a paragraph'...")
    assertion( "            Should result in a detected self repair", input_history.detect_self_repair(["a", "paragraph"]) == True )
    assertion( "    Replacement of word")
    assertion( "        Inserting the words 'a new word'...")
    assertion( "            Should result in a detected self repair", input_history.detect_self_repair(["a", "new", "word"]) == True )
    assertion( "    Insertion in between words")
    assertion( "        Inserting the words 'a new word paragraph'... ")
    assertion( "           Should result in a detected self repair", input_history.detect_self_repair(["a", "new", "word", "paragraph"]) == True )
    assertion( "    Insertion and appending")
    assertion( "        Inserting the words 'an old paragraph insert'... ")
    assertion( "           Should result in a detected self repair", input_history.detect_self_repair(["a", "new", "word", "paragraph", "insert"]) == True )

def test_add_known_self_repair_examples(assertion):
    assertion( "With a input history filled with examples of wrong self repair")
    assertion( "    Inserting 'forget what we want to say' after 'when we'")
    ihm = get_filled_ihm_with_examples(["when", "we"])
    assertion( "        Should not result in self repair", ihm.detect_self_repair(["forget", "what", "we", "want", "to", "say"]) == False)
    assertion( "    Inserting 'that would give us' after 'that is a fact'")
    ihm = get_filled_ihm_with_examples(["that", "is", "a", "fact"])
    assertion( "        Should not result in self repair", ihm.detect_self_repair(["that", "would", "give", "us"]) == False)
    assertion( "    Inserting 'is it a' after 'is it a problem'")
    ihm = get_filled_ihm_with_examples(["is", "it", "a", "problem"])
    assertion( "        Should not result in self repair", ihm.detect_self_repair(["is", "it", "a"]) == False)
    assertion( "    Inserting 'this is the test' after 'this is a test'")
    ihm = get_filled_ihm_with_examples(["this", "is", "a", "test"])
    assertion( "        Should result in self repair", ihm.detect_self_repair(["this", "is", "the", "test"]) == True)
    assertion( "    Inserting 'formulate a paragraph' after 'formulate a sentence'")
    ihm = get_filled_ihm_with_examples(["formulate", "a", "sentence"])
    assertion( "        Should result in self repair", ihm.detect_self_repair(["formulate", "a", "paragraph"]) == True)
    assertion( "    Inserting 'do fixes all the time' after 'want to'")
    ihm = get_filled_ihm_with_examples(["want", "to"])
    assertion( "        Should not result in self repair", ihm.detect_self_repair(["do", "fixes", "all", "the", "time"]) == False)
    ihm = get_filled_ihm_with_examples(["when", "we", "make", "mistakes,", "we", "tend", "to", "repeat", "ourselves"])
    assertion( "    Inserting 'we tend to repeat the words' after 'when we make mistakes, we tend to repeat ourselves'")
    assertion( "        Should result in self repair", ihm.detect_self_repair(["we", "tend", "to", "repeat", "the", "words"]) == True)
    ihm = get_filled_ihm_with_examples(["a", "lot", "of"])
    assertion( "    Inserting 'different kinds of' after 'a lot of'")
    assertion( "        Should not result in self repair", ihm.detect_self_repair(["different", "kinds", "of", "people"]) == False)

suite = create_test_suite("Self repair in dictation")
suite.add_test(test_detect_self_repair)
suite.add_test(test_add_known_self_repair_examples)